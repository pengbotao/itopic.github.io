<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Linux下Nginx、Mysql、PHP环境安装 - 老彭的博客</title>
    <link rel="stylesheet" href="/static/css/markdown.css">
    <script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?0f0111c99240380ee020030f3be990f5";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script language="javascript">
    if (document.domain =='pengbotao.cn' || document.domain == 'www.pengbotao.cn')
    this.location = "http://itopic.org" + this.location.pathname + this.location.search;
    </script>
</head>
<body>
<h1 style="font-weight:600;width:90%;margin-bottom:0px;">Linux下Nginx、Mysql、PHP环境安装</h1>
<a href="http://itopic.org/"><img src="/static/img/arrow-back.png" style="width:25px;height:25px;float:right;margin-top:-15px;" /></a>
<hr />
<h1>一、OpenResty</h1>

<p>OpenResty 是一个基于 Nginx 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。</p>

<h2>1.1 安装</h2>

<pre><code># yum -y install readline-devel pcre-devel openssl-devel perl gcc
# wget https://openresty.org/download/openresty-1.9.7.4.tar.gz
# tar zxvf openresty-1.9.7.4.tar.gz
# cd openresty-1.9.7.4
# ./configure --prefix=/usr/local/server/openresty1.9.7 \
--with-luajit \
--without-http_redis2_module \
--with-http_iconv_module
# gmake
# gmake install
</code></pre>

<h2>1.2 Nginx参考配置</h2>

<p>配置nginx.conf，通过vhost目录将所有配置文件放在此目录下，特定站定只需要关注该站点的配置文件即可。</p>

<pre><code>#user  nobody;
worker_processes 2;
error_log /data/log/nginx/nginx_error.log crit;
#Specifies the value for maximum file descriptors that can be opened by this process.
worker_rlimit_nofile 65536;
events
    {
        use epoll;
        worker_connections 65536;
    }
http
    {
        include       mime.types;
        default_type  application/octet-stream;
        server_names_hash_bucket_size 128;
        client_header_buffer_size 32k;
        large_client_header_buffers 4 32k;
        client_max_body_size 50m;
        sendfile on;
        tcp_nopush     on;
        keepalive_timeout 60;
        tcp_nodelay on;
        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
        fastcgi_read_timeout 300;
        fastcgi_buffer_size 64k;
        fastcgi_buffers 4 64k;
        fastcgi_busy_buffers_size 128k;
        fastcgi_temp_file_write_size 256k;
        gzip on;
        gzip_min_length  1k;
        gzip_buffers     4 16k;
        gzip_http_version 1.0;
        gzip_comp_level 2;
        gzip_types       text/plain application/x-javascript text/css application/xml;
        gzip_vary on;
        log_format  access  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '
             '$status $body_bytes_sent &quot;$http_referer&quot; '
             '&quot;$http_user_agent&quot; $http_x_forwarded_for';
        #limit_zone  crawler  $binary_remote_addr  10m;
        server {
                listen 80 default;
                return 500;
        }
        include vhost/*.conf;
}
</code></pre>

<p>配置server部分，此示例有判断文件不存在时解析到index.php</p>

<pre><code>server
{
    listen       80;
    server_name localhost;
    index index.html index.php;
    root  /data/www/public;
    location /
    {
        if (!-e $request_filename)
        {
            rewrite . /index.php last;
        }
    }
    location ~ .*\.(php|php5)?$
    {
        fastcgi_pass  127.0.0.1:9000;
        fastcgi_index index.php;
        include fastcgi.conf;
    }
    location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$
    {
        expires      30d;
    }
    location ~ .*\.(js|css)?$
    {
        expires      12h;
    }
    access_log  /data/log/nginx/localhost_access.log  access;
}
</code></pre>

<h2>1.3 Nginx启动</h2>

<pre><code>-- 检测配置文件配置是否正确，如错误会有报错信息
/usr/local/server/openresty1.9.7/nginx/sbin/nginx -t
-- 启动nginx
/usr/local/server/openresty1.9.7/nginx/sbin/nginx
-- 重启动nginx
/usr/local/server/openresty1.9.7/nginx/sbin/nginx reload
</code></pre>

<h1>二、Mysql配置</h1>

<h2>2.1 安装</h2>

<p>配置mysql用户</p>

<pre><code># groupadd mysql
# useradd -s /sbin/nologin -g mysql mysql
# mkdir -p /data/mysql/3306
# chown -R mysql:mysql 3306/
</code></pre>

<p>安装依赖包</p>

<pre><code># yum -y install gcc gcc-c++ ncurses ncurses-devel cmake
</code></pre>

<p>下载相应源码包，从MySQL 5.7.5开始Boost库是必需的</p>

<pre><code># wget http://downloads.sourceforge.net/project/boost/boost/1.59.0/boost_1_59_0.tar.gz
# wget http://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.12.tar.gz
</code></pre>

<p>预编译</p>

<pre><code># tar zxvf mysql-5.7.12.tar.gz
# cd mysql5.7.2
# cmake . -DCMAKE_INSTALL_PREFIX=/usr/local/server/mysql5.7.12 \
-DMYSQL_DATADIR=/data/mysql/3306 \
-DSYSCONFDIR=/data/mysql/3306 \
-DDEFAULT_CHARSET=utf8mb4 \
-DDEFAULT_COLLATION=utf8mb4_unicode_ci  \
-DEXTRA_CHARSETS=all \
-DENABLED_LOCAL_INFILE=1 \
-DDOWNLOAD_BOOST=1 \
-DWITH_BOOST=/root/package
# make
# make install
</code></pre>

<p>初始化数据库，之前版本mysql_install_db是在mysql_basedir/script下，5.7放在了mysql_install_db/bin目录下,且已被废弃</p>

<pre><code>2016-04-15 17:25:52 [WARNING] mysql_install_db is deprecated. Please consider switching to mysqld --initialize
2016-04-15 17:25:52 [ERROR] The data directory needs to be specified.
</code></pre>

<p>“–initialize”会生成一个随机密码(~/.mysql_secret)，而”–initialize-insecure”不会生成密码。–datadir目标目录下不能有数据文件</p>

<pre><code>/usr/local/server/mysql5.7.12/bin/mysqld \
--initialize-insecure \
--user=mysql \
--basedir=/usr/local/server/mysql5.7.12 \
--datadir=/data/mysql/3306/data
</code></pre>

<p>拷贝配置文件</p>

<pre><code># cp support-files/my-default.cnf /data/mysql/3306/my.cnf
</code></pre>

<h2>2.2 启动</h2>

<pre><code>-- 启动
/usr/local/server/mysql5.7.12/bin/mysqld_safe --defaults-file=/data/mysql/3306/my.cnf &gt; /dev/null &amp;
-- 关闭
/usr/local/server/mysql5.7.12/bin/mysqladmin -uroot -p -h localhost -P3306 shutdown
</code></pre>

<h2>2.3 设置配置文件</h2>

<pre><code># For advice on how to change settings please see
# http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html
# *** DO NOT EDIT THIS FILE. It's a template which will be copied to the
# *** default location during install, and will be replaced if you
# *** upgrade to a newer version of MySQL.
[mysqld]
user = mysql
# Remove leading # and set to the amount of RAM for the most important data
# cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.
innodb_buffer_pool_size = 128M
# Remove leading # to turn on a very important data integrity option: logging
# changes to the binary log between backups.
# log_bin
# These are commonly set, remove the # and set as required.
basedir = /usr/local/webserver/mysql
datadir = /data/mysql/3306/data
port = 3306
server_id = 1
socket = /tmp/mysql.sock
# Remove leading # to set options mainly useful for reporting servers.
# The server defaults are faster for transactions and fast SELECTs.
# Adjust sizes as needed, experiment to find the optimal values.
join_buffer_size = 128M
sort_buffer_size = 2M
read_rnd_buffer_size = 2M
sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES
auto_increment_increment = 1
slow_query_log
long_query_time = 3
innodb_file_per_table = 1
</code></pre>

<h1>三、REDIS安装</h1>

<pre><code># yum -y install tcl
# wget http://download.redis.io/releases/redis-3.0.7.tar.gz
# tar zxvf redis-3.0.7.tar.gz
# cd redis-3.0.7
# mkdir -p /usr/local/server/redis3.0.7
# make prefix=/usr/local/server/redis3.0.7 install
# cp redis.conf /etc/
 
-- 启动REDIS
# /usr/local/server/redis3.0.7/bin/redis-server /etc/redis.conf&amp;
</code></pre>

<h1>四、PHP安装</h1>

<h2>4.1 安装依赖包</h2>

<p>安装libmcrypt，未安装时会报如下错误</p>

<blockquote>
<p>configure: error: mcrypt.h not found. Please reinstall libmcrypt.</p>
</blockquote>

<pre><code># wget https://sourceforge.net/projects/mcrypt/files/Libmcrypt/2.5.8/libmcrypt-2.5.8.tar.gz/download
# mv download libmcrypt-2.5.8.tar.gz
# tar zxvf libmcrypt-2.5.8.tar.gz
# cd libmcrypt-2.5.8
# ./configure --prefix=/usr/local
# make
# make install
</code></pre>

<blockquote>
<p>configure: error: Don&rsquo;t know how to define struct flock on this system, set &ndash;enable-opcache=no</p>
</blockquote>

<pre><code># echo &quot;/usr/local/lib&quot; &gt;&gt; /etc/ld.so.conf.d/local.conf
# ldconfig -v
</code></pre>

<h1>4.2 安装PHP</h1>

<pre><code># wget http://cn2.php.net/get/php-7.0.5.tar.gz/from/this/mirror
# mv mirror php-7.0.5.tar.gz
# tar zxvf php-7.0.5.tar.gz
# cd php-7.0.5
# yum -y install gcc gcc-c++ libxml2 libxml2-devel autoconf libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel  zlib zlib-devel glibc glibc-devel glib2 glib2-devel libcurl libcurl--devel curl-devel curl libmcrypt libmcrypt-devel   bzip2 bzip2-devel libmcrypt libmcrypt-devel
# ./configure --prefix=/usr/local/server/php7.0.5 \
--enable-fpm \
--enable-opcache \
--with-mcrypt \
--with-zlib \
--enable-mbstring \
--with-curl \
--disable-debug  \
--disable-rpath \
--enable-inline-optimization \
--with-bz2  \
--with-zlib \
--enable-sockets \
--enable-sysvsem \
--enable-sysvshm \
--enable-pcntl \
--enable-mbregex \
--with-mhash \
--enable-shmop  \
--enable-zip \
--with-pcre-regex  \
--with-gd  \
--with-gettext  \
--enable-bcmath  \
--with-png-dir  \
--with-freetype-dir \
--with-jpeg-dir \
--with-openssl \
--enable-pdo \
--with-pdo-mysql \
--enable-mysqlnd \
--with-mysqli=mysqlnd \
--with-pdo-mysql=mysqlnd
# make
# make install
# cp php.ini-production /usr/local/server/php7.0.5/lib/php.ini
# cd /usr/local/server/php7.0.5/etc
# cp php-fpm.conf.default php-fpm.conf
# vi php-fpm.conf
# cp php-fpm.d/www.conf.default php-fpm.d/www.conf
</code></pre>

<h2>4.3 php-fpm启动、重启、终止</h2>

<p>php 5.3.3 源码中已经内嵌了 php-fpm，不用象以前的php版本一样专门打补丁了，只需要在configure的时候添加编译参数即可。不再支持 php-fpm 以前具有的 /usr/local/php/sbin/php-fpm (start|stop|reload)等命令，需要使用信号控制：</p>

<ul>
<li>INT, TERM 立刻终止</li>
<li>QUIT 平滑终止</li>
<li>USR1 重新打开日志文件</li>
<li>USR2 平滑重载所有worker进程并重新载入配置和二进制模块</li>
</ul>

<pre><code>-- 启动PHP-Fpm
# /usr/local/server/php7.0.5/sbin/php-fpm
 
-- php-fpm 关闭：
# kill -INT `cat /usr/local/server/php7.0.5/var/run/php-fpm.pid`
 
-- php-fpm 重启：
# kill -USR2 `cat /usr/local/server/php/var/run/php-fpm.pid`
</code></pre>

<h2>4.4 设置自启动</h2>

<pre><code>-- 设置自启动
# echo '/usr/local/server/php7.0.5/sbin/php-fpm' &gt;&gt;/etc/rc.local
 
-- 设置软链接
# ln -s /usr/local/webserver/php7.0.5/bin/php /usr/bin/php
</code></pre>

<h2>4.5 PHP配置文件设置</h2>

<pre><code>-- 设置时区
date.timezone = PRC
-- 去掉头PHP返回
expose_php = Off
</code></pre>

<h2>4.6 扩展安装</h2>

<h3>4.6.1 REDIS扩展</h3>

<p>安装完成后会显示so路径，需修改php.ini添加到so到配置文件中。</p>

<pre><code># wget https://github.com/phpredis/phpredis/archive/php7.zip
# unzip php7.zip
# cd phpredis-php7
# /usr/local/server/php7.0.5/bin/phpize
# ./configure --with-php-config=/usr/local/server/php7.0.5/bin/php-config
# make
# make install
</code></pre>

<div style="padding: 0 10px;float:left;margin-bottom:20px;color:#aaa;">-- EOF --</div>
<div style="float:right;">
    <a href="http://itopic.org/"><img src="/static/img/arrow-back.png" style="width:25px;height:25px;" /></a>
</div>
<div style="padding: 0 10px;text-align:right;float:right;">
    发表于：
    <code style="border:0px;background:none;"><a href="/2016-05.html">2016-05-23 19:00</a></code>
</div>
<div style="padding: 0 10px;text-align:right;float:right;">
    标签：
    <code style="border:0px;background:none;"><a href="/tag/php.html">PHP</a></code>
    <code style="border:0px;background:none;"><a href="/tag/linux.html">Linux</a></code>
    <code style="border:0px;background:none;"><a href="/tag/环境部署.html">环境部署</a></code>
</div>

<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="linux-web-server" data-title="Linux下Nginx、Mysql、PHP环境安装" data-url="http://itopic.org/linux-web-server.html"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"itopic"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->
</body>
</html>